<script>
    // Variables globales
    let chart = null;
    let isSimulating = false;
    
    // Inicialización
    function initializeApp() {
        if (typeof Chart === 'undefined') {
            setTimeout(initializeApp, 100);
            return;
        }
        setupEventListeners();
        runSimulation(); // Simulación inicial
    }

    function setupEventListeners() {
        // Slider de volatilidad
        const volatilitySlider = document.getElementById('volatility');
        const volatilityValue = document.getElementById('volatilityValue');
        volatilitySlider.addEventListener('input', function() {
            volatilityValue.textContent = this.value + '%';
        });

        // Botón de simulación
        const simulateBtn = document.getElementById('simulateBtn');
        simulateBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (!isSimulating) runSimulation();
        });

        // Enter en símbolo
        document.getElementById('stockSymbol').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !isSimulating) {
                runSimulation();
            }
        });

        console.log('Event listeners configurados correctamente');
    }

    // Generar datos históricos
    function generateHistoricalData(symbol, days = 30) {
        const data = [];
        const startPrice = getBasePrice(symbol);
        let price = startPrice;
        const today = new Date();

        for (let i = days; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            const change = (Math.random() - 0.48) * 0.03;
            price = Math.max(price * (1 + change), startPrice * 0.5);
            data.push({ date: date.toISOString().split('T')[0], price });
        }
        return data;
    }

    function getBasePrice(symbol) {
        const basePrices = {
            'GOOGL': 150, 'AAPL': 180, 'TSLA': 250, 'MSFT': 350,
            'AMZN': 140, 'META': 320, 'NVDA': 450, 'NFLX': 400,
            'BABA': 80, 'UBER': 70, 'SPOT': 200, 'DEFAULT': 100
        };
        return basePrices[symbol.toUpperCase()] || basePrices['DEFAULT'];
    }

    function simulateFuturePrice(currentPrice, days, volatility, trend) {
        const data = [];
        let price = currentPrice;
        const trendMultipliers = { bullish: 0.0008, neutral: 0.0002, bearish: -0.0004 };
        const drift = trendMultipliers[trend];
        const dailyVolatility = volatility / 100 / Math.sqrt(252);
        const today = new Date();

        data.push({ date: today.toISOString().split('T')[0], price });
        for (let i = 1; i <= days; i++) {
            const date = new Date(today);
            date.setDate(date.getDate() + i);
            const randomShock = (Math.random() - 0.5) * 2;
            const dailyReturn = drift + dailyVolatility * randomShock;
            price = Math.max(price * (1 + dailyReturn), currentPrice * 0.2);
            data.push({ date: date.toISOString().split('T')[0], price });
        }
        return data;
    }

    function runSimulation() {
        if (isSimulating) return;
        isSimulating = true;

        const symbol = (document.getElementById('stockSymbol').value || 'GOOGL').toUpperCase();
        const days = parseInt(document.getElementById('timeHorizon').value) || 90;
        const volatility = parseInt(document.getElementById('volatility').value) || 20;
        const trend = document.getElementById('trend').value || 'neutral';
        const numScenarios = parseInt(document.getElementById('scenarios').value) || 3;

        updateStatus('Ejecutando simulación...');
        showLoading(symbol);

        setTimeout(() => {
            try {
                const historicalData = generateHistoricalData(symbol, 30);
                const currentPrice = historicalData[historicalData.length - 1].price;

                const scenarios = [];
                const allFinalPrices = [];
                for (let i = 0; i < numScenarios; i++) {
                    const futureData = simulateFuturePrice(currentPrice, days, volatility, trend);
                    scenarios.push(futureData);
                    allFinalPrices.push(futureData[futureData.length - 1].price);
                }

                const avgFinalPrice = allFinalPrices.reduce((a, b) => a + b, 0) / allFinalPrices.length;
                const expectedReturn = ((avgFinalPrice - currentPrice) / currentPrice) * 100;
                const variance = allFinalPrices.reduce((acc, price) => acc + Math.pow(price - avgFinalPrice, 2), 0) / allFinalPrices.length;
                const standardDeviation = Math.sqrt(variance);
                const riskPercent = (standardDeviation / currentPrice) * 100;

                updateChart(historicalData, scenarios, symbol);
                updateStats(currentPrice, avgFinalPrice, expectedReturn, riskPercent);
                hideLoading();
                showMessage(`✅ Simulación completada para ${symbol} con ${numScenarios} escenarios`, 'success');
                updateStatus(`Última simulación: ${symbol} - ${new Date().toLocaleTimeString()}`);
            } catch (error) {
                hideLoading();
                showMessage('❌ Error en la simulación: ' + error.message, 'error');
                updateStatus('Error en simulación');
            } finally {
                isSimulating = false;
            }
        }, 1000);
    }

    function updateChart(historicalData, scenarios, symbol) {
        const ctx = document.getElementById('stockChart').getContext('2d');
        if (chart) chart.destroy();

        const allLabels = [];
        const historicalPrices = [];
        historicalData.forEach(p => { allLabels.push(formatDate(p.date)); historicalPrices.push(p.price); });
        scenarios[0].slice(1).forEach(p => allLabels.push(formatDate(p.date)));

        const datasets = [{
            label: 'Histórico',
            data: historicalPrices.concat(new Array(scenarios[0].length - 1).fill(null)),
            borderColor: '#2c3e50',
            borderWidth: 3,
            fill: false,
            pointRadius: 0
        }];

        const colors = ['#e74c3c','#3498db','#2ecc71','#f39c12','#9b59b6','#1abc9c','#34495e','#e67e22','#95a5a6','#f1c40f'];
        scenarios.forEach((scenario, i) => {
            const futureData = new Array(historicalData.length - 1).fill(null);
            scenario.forEach(p => futureData.push(p.price));
            datasets.push({
                label: `Escenario ${i + 1}`,
                data: futureData,
                borderColor: colors[i % colors.length],
                borderWidth: 2,
                fill: false,
                pointRadius: 0,
                borderDash: [5, 5]
            });
        });

        chart = new Chart(ctx, {
            type: 'line',
            data: { labels: allLabels, datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top' } },
                scales: { x: { title: { display: true, text: 'Fecha' } }, y: { title: { display: true, text: 'Precio ($)' } } }
            }
        });
    }

    function updateStats(currentPrice, avgFinalPrice, expectedReturn, risk) {
        document.getElementById('currentPrice').textContent = `$${currentPrice.toFixed(2)}`;
        document.getElementById('avgFinalPrice').textContent = `$${avgFinalPrice.toFixed(2)}`;
        document.getElementById('expectedReturn').textContent = `${expectedReturn.toFixed(2)}%`;
        document.getElementById('riskValue').textContent = `${risk.toFixed(2)}%`;
    }

    function showMessage(message, type) {
        const messageDiv = document.getElementById('messageDiv');
        messageDiv.className = 'message ' + type;
        messageDiv.textContent = message;
        messageDiv.style.display = 'block';
        setTimeout(() => { messageDiv.style.display = 'none'; }, 4000);
    }

    function showLoading(symbol) {
        document.getElementById('loadingDiv').style.display = 'block';
        document.getElementById('loadingStock').textContent = symbol;
    }
    function hideLoading() { document.getElementById('loadingDiv').style.display = 'none'; }
    function updateStatus(status) { document.getElementById('statusDiv').textContent = status; }
    function formatDate(dateStr) { return new Date(dateStr).toLocaleDateString('es-ES',{month:'short',day:'numeric'}); }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
        initializeApp();
    }
</script>
